C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE BEMFDETECT
OBJECT MODULE PLACED IN .\Debug\BEMFDetect.obj
COMPILER INVOKED BY: E:\KEIL\KEIL4\C51\BIN\C51.EXE ..\User\source\Function\BEMFDetect.c LARGE OMF2 BROWSE INCDIR(..\FU68
                    -xx_Hardware_Driver\Include;..\User\include) DEBUG PRINT(.\Listings\BEMFDetect.lst) OBJECT(.\Debug\BEMFDetect.obj)

line level    source

   1          /* --------------------------- (C) COPYRIGHT 2021 Fortiortech ShenZhen -----------------------------
   2              File Name      : BEMFDetect.c
   3              Author         : Lewis.wang
   4              Version        : V1.0
   5              Date           : 2021-12-30
   6              Description    : This file contains XX-XX-XX function used for Motor Control.
   7          ----------------------------------------------------------------------------------------------------  
   8                                                 All Rights Reserved
   9          ------------------------------------------------------------------------------------------------- */
  10          #include <Myproject.h>
  11          BEMFDetect_TypeDef xdata BEMFDetect;
  12          /* -------------------------------------------------------------------------------------------------
  13              Function Name  : BEMFDetectInit
  14              Description    : BEMFçš„åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬å˜é‡åˆå§‹åŒ–ï¼Œä½¿èƒ½æ¯”è¾ƒå™¨
  15              Date           : 2021-12-30
  16              Parameter      : None
  17          ------------------------------------------------------------------------------------------------- */
  18          void BEMFDetectInit(void)
  19          {
  20   1          BEMFDetect.BEMFSpeed           = 0;
  21   1          BEMFDetect.BEMFSpeedBase       = 0;
  22   1          BEMFDetect.BEMFStatus          = 0;
  23   1          BEMFDetect.FRStatus            = 0;
  24   1          BEMFDetect.BEMFTimeCount       = BEMF_START_DETECT_TIME;    //åˆå§‹åç”µåŠ¨åŠ¿æ£€æµ‹æ—¶é—´
  25   1          mcFocCtrl.State_Count = TailWind_Time;
  26   1          BEMFDetect.BEMFSpeedInitStatus = 0;
  27   1          BEMFDetect.FlagSpeedCal        = 0;
  28   1          BEMFDetect.BEMFStartStatus     = 0;
  29   1              
  30   1          //ä½¿èƒ½å®šæ—¶å™¨2ç”¨äºŽæ£€æµ‹æ—¶é—´
  31   1          Time2_BEMF_Init();
  32   1          CMP_BEMF_Init();
  33   1      }
  34          /* -------------------------------------------------------------------------------------------------
  35              Function Name  : CMP_BMEF_Init
  36              Description    : CMP0/1/2çš„åˆå§‹åŒ–
  37              Date           : 2021-12-30
  38              Parameter      : None
  39          ------------------------------------------------------------------------------------------------- */
  40          void CMP_BEMF_Init(void)
  41          {
  42   1          /*-------------------------------------------------------------------------------------------------
  43   1          CMP Input Pin Mode
  44   1          0: GPIO Mode, P1.4--CMP0_IN+, P1.6--CMP1_IN+, P2.1--CMP2_IN+
  45   1                        P1.5--CMP0_IN-, P1.7--CMP1_IN-, P2.2--CMP2_IN-
  46   1          1: BEMF Mode, æ¯”è¾ƒå™¨æ­£ç«¯è¿žæŽ¥åˆ°å†…éƒ¨æ˜Ÿåž‹è¿žæŽ¥ç”µé˜»Uã€Vã€Wçš„BMEFé‡‡æ ·ç‚¹ï¼Œ
  47   1                        æ¯”è¾ƒå™¨è´Ÿç«¯è¿žæŽ¥åˆ°å†…éƒ¨æ˜Ÿåž‹è¿žæŽ¥ç”µé˜»çš„è™šæ‹Ÿä¸­æ€§ç‚¹
  48   1                        æ¯”è¾ƒå™¨è´Ÿç«¯ä¸ŽP1.5/P1.7/P2.2æ–­å¼€ï¼Œè¿™ä¸‰ä¸ªGPIOå¯åšå…¶ä»–ç”¨é€”
  49   1          -------------------------------------------------------------------------------------------------*/
  50   1          SetBit(P1_AN , P14 | P16);  //CMP0/1 Pinè®¾ç½®ä¸ºæ¨¡æ‹Ÿæ¨¡å¼  +
  51   1          SetBit(P2_AN , P21);        //CMP2 Pinè®¾ç½®ä¸ºæ¨¡æ‹Ÿæ¨¡å¼  +
  52   1          ClrBit(P1_PU , P14);        //P14ä¸Šæ‹‰å…³é—­
  53   1          /*-------------------------------------------------------------------------------------------------
  54   1             CMP0_MODï¼š
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 2   

  55   1             00ï¼š  æ— å†…ç½®è™šæ‹Ÿä¸­å¿ƒç‚¹ç”µé˜»çš„BEMFæ¨¡å¼
  56   1             01ï¼š  å†…ç½®è™šæ‹Ÿä¸­å¿ƒç‚¹ç”µé˜»çš„BEMFæ¨¡å¼
  57   1             10ï¼š  3å·®åˆ†æ¯”è¾ƒå™¨æ¨¡å¼
  58   1             11ï¼š  2æ¯”è¾ƒå™¨æ¨¡å¼
  59   1          -------------------------------------------------------------------------------------------------*/
  60   1          SetReg(CMP_CR2 , CMP0MOD0 | CMP0MOD1 , CMP0MOD0);
  61   1          /*-------------------------------------------------------------------------------------------------
  62   1            æ¯”è¾ƒå™¨è¾“å‡ºé€‰æ‹©é…ç½®ï¼Œä¸ŽCMP0_MODé…åˆä½¿ç”¨
  63   1            CMP0_SEL[1:0]=00ï¼Œæ¯”è¾ƒå™¨0å·¥ä½œåœ¨3æ¯”è¾ƒå™¨è½®è¯¢æ¨¡å¼ï¼Œæ­£ç«¯åœ¨CMP0Pã€CMP1Pã€CMP2Pä¹‹é—´è
             -‡ªåŠ¨è½®æµé€‰æ‹©ï¼Œ
  64   1                            è´Ÿç«¯å›ºå®šæŽ¥å†…ç½®BEMFç”µé˜»çš„ä¸­å¿ƒç‚¹ï¼Œå…¶è¾“å‡ºç»“æžœåˆ†åˆ«é€è‡³CMP0_OUTã€
             -CMP1_OUTã€CMP2_OUT
  65   1            CMP0_SEL[1:0]=01ï¼Œæ¯”è¾ƒå™¨0é€‰æ‹©CMP0å¯¹åº”çš„ç«¯å£ç»„åˆï¼Œæ­£ç«¯æŽ¥CMP0Pï¼Œè´Ÿç«¯æŽ¥å†…ç½®BEMFç
             -”µé˜»çš„ä¸­å¿ƒç‚¹ï¼Œè¾“å‡ºæŽ¥CMP0_OUT
  66   1            CMP0_SEL[1:0]=10ï¼Œæ¯”è¾ƒå™¨0é€‰æ‹©CMP1å¯¹åº”çš„ç«¯å£ç»„åˆï¼Œæ­£ç«¯æŽ¥CMP1Pï¼Œè´Ÿç«¯æŽ¥å†…ç½®BEMFç
             -”µé˜»çš„ä¸­å¿ƒç‚¹ï¼Œè¾“å‡ºæŽ¥CMP1_OUT
  67   1            CMP0_SEL[1:0]=11ï¼Œæ¯”è¾ƒå™¨0é€‰æ‹©CMP2å¯¹åº”çš„ç«¯å£ç»„åˆï¼Œæ­£ç«¯æŽ¥CMP2Pï¼Œè´Ÿç«¯æŽ¥å†…ç½®BEMFç
             -”µé˜»çš„ä¸­å¿ƒç‚¹ï¼Œè¾“å‡ºæŽ¥CMP2_OUT
  68   1          -----------------------------------------------------------------------------*/
  69   1          SetReg(CMP_CR2 , CMP0SEL0 | CMP0SEL1 , 0x00);
  70   1           SetBit(CMP_CR1,HALLSEL);
  71   1          /*-------------------------------------------------------------------------------------------------
  72   1              æ¯”è¾ƒå™¨è¿Ÿæ»žç”µåŽ‹é€‰æ‹©
  73   1              000: æ— è¿Ÿæ»ž   001: Â±2.5mV   010: -5mV   011: +5mV
  74   1              100: +-5mV   101: -10mV   110: +10mV   111: +-10mV
  75   1          -------------------------------------------------------------------------------------------------*/
  76   1          SetReg(CMP_CR1 , CMP0HYS0 | CMP0HYS1 | CMP0HYS2 , CMP0HYS0 | CMP0HYS1 | CMP0HYS2);
  77   1          /*-------------------------------------------------------------------------------------------------
  78   1              CMP0çš„è½®è¯¢æ—¶é—´è®¾ç½®
  79   1          -------------------------------------------------------------------------------------------------*/
  80   1          SetReg(CMP_CR2 , CMP0CSEL1 | CMP0CSEL0 , 0x00);
  81   1           
  82   1          /*-------------------------------------------------------------------------------------------------
  83   1              æ¯”è¾ƒå™¨ä¸­æ–­æ¨¡å¼é…ç½®
  84   1              00: ä¸äº§ç”Ÿä¸­æ–­  01: ä¸Šå‡æ²¿äº§ç”Ÿä¸­æ–­  10: ä¸‹é™æ²¿äº§ç”Ÿä¸­æ–­  11: ä¸Šå‡/ä¸‹é™æ²¿äº§
             -ç”Ÿä¸­æ–­
  85   1          -------------------------------------------------------------------------------------------------*/
  86   1          SetReg(CMP_CR0 , CMP2IM0 | CMP2IM1 , CMP2IM0 | CMP2IM1);
  87   1          SetReg(CMP_CR0 , CMP1IM0 | CMP1IM1 , CMP1IM0 | CMP1IM1);
  88   1          SetReg(CMP_CR0 , CMP0IM0 | CMP0IM1 , CMP0IM0 | CMP0IM1);
  89   1      
  90   1          ClrBit(CMP_CR4 , CMP0_FS);//CMP1/2åŠŸèƒ½è½¬ç§»      ä»…CMP0_MOD=01æ—¶æœ‰æ•ˆ
  91   1          
  92   1          PCMP1 = 0;
  93   1          PCMP0 = 1;
  94   1          
  95   1          SetBit(CMP_CR2 , CMP0EN); //å¼€ä¸‰ä¸ªæ¯”è¾ƒå™¨
  96   1      }
  97          /* -------------------------------------------------------------------------------------------------
  98              Function Name  : Time2_BMEF_Init
  99              Description    : BMFå¯¹åº”Time2çš„åˆå§‹åŒ–
 100              Date           : 2021-12-30
 101              Parameter      : None
 102          ------------------------------------------------------------------------------------------------- */
 103          void Time2_BEMF_Init(void)
 104          {
 105   1          /*-------------------------------------------------------------------------------------------------
 106   1          å…ˆåœæ­¢è®¡æ•°ï¼Œé…ç½®å®Œå¯„å­˜å™¨åŽï¼Œæœ€åŽå¯åŠ¨è®¡æ•°
 107   1          -------------------------------------------------------------------------------------------------*/
 108   1          ClrBit(TIM2_CR1 , T2CEN);// 0ï¼Œåœæ­¢è®¡æ•°ï¼›1,ä½¿èƒ½è®¡æ•°
 109   1      
 110   1          /*-------------------------------------------------------------------------------------------------
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 3   

 111   1          æ—¶é’Ÿåˆ†é¢‘è®¾ç½®(T2PSC)
 112   1          000:cpuclk(24MHz)         001:cpuclk/2^1(12MHz)   010:cpuclk/2^2(6MHz)    011:cpuclk/2^3(3MHz)
 113   1          100:cpuclk/2^4(1.5MHz)    101:cpuclk/2^5(750KHz)  110:cpuclk/2^6(375KHz)  111:cpuclk/2^7(187.5KHz)
 114   1          -------------------------------------------------------------------------------------------------*/
 115   1          SetReg(TIM2_CR0 , T2PSC0 | T2PSC1 | T2PSC2 , T2PSC0 | T2PSC1 | T2PSC2);
 116   1          /*-------------------------------------------------------------------------------------------------
 117   1          /æ¨¡å¼é€‰æ‹©
 118   1          T2MODE1ï¼ŒT2MODE0
 119   1          00--è¾“å…¥Timeræ¨¡å¼ï¼›01--è¾“å‡ºæ¨¡å¼
 120   1          10--è¾“å…¥Countæ¨¡å¼ï¼›11--QEPæˆ–è€…ISDæ¨¡å¼
 121   1          -------------------------------------------------------------------------------------------------*/
 122   1          SetReg(TIM2_CR0 , T2MOD0 | T2MOD1, T2MOD0);
 123   1          /*-------------------------------------------------------------------------------------------------
 124   1          æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½
 125   1          ç¦æ­¢PWMå‘¨æœŸæ£€æµ‹ä¸­æ–­ä½¿èƒ½
 126   1          -------------------------------------------------------------------------------------------------*/
 127   1          ClrBit(TIM2_CR0 , T2CES);                               // æ¸…é›¶è„‰å†²è®¡æ•°å™¨ä¸ä½¿èƒ½
 128   1          ClrBit(TIM2_CR1 , T2IR | T2IF | T2IP);                  // æ¸…é›¶ä¸­æ–­æ ‡å¿—ä½
 129   1          SetBit(TIM2_CR1 , T2IFE);
 130   1          /*-------------------------------------------------------------------------------------------------
 131   1          é…ç½®å‘¨æœŸå€¼ã€æ¯”è¾ƒå€¼ã€è®¡æ•°å€¼
 132   1          ç¦æ­¢PWMå‘¨æœŸæ£€æµ‹ä¸­æ–­ä½¿èƒ½
 133   1          ä½¿èƒ½è®¡æ•°å™¨ä¸Šæº¢ä¸­æ–­ä½¿èƒ½
 134   1          -------------------------------------------------------------------------------------------------*/
 135   1          TIM2__ARR  = 60000;                                    // TIM2 Period = 0.32s
 136   1          TIM2__DR   = TIM2__ARR;
 137   1          TIM2__CNTR = 0;
 138   1          /*-----------å¯åŠ¨è®¡æ•°------------------------------------------------*/
 139   1          SetBit(TIM2_CR1 , T2CEN);                                //å¯åŠ¨è®¡æ•°
 140   1      
 141   1      }
 142          /* -------------------------------------------------------------------------------------------------
 143              Function Name  : CWCCWDetect
 144              Description    : åŠŸèƒ½å‡½æ•°ï¼Œæ£€æµ‹ç”µæœºè½¬å‘ï¼Œæ ¹æ®ç›¸é‚»ä¸¤ä¸ªHallçŠ¶æ€é¡ºåºæ¥åˆ¤æ–­ç”µæœº
             -è½¬å‘
 145              Date           : 2021-12-30
 146              Parameter      : HallStatus: [è¾“å…¥:éœå°”çŠ¶æ€] 
 147          ------------------------------------------------------------------------------------------------- */
 148          uint8 CWCCWDetect(uint8 HallStatus, uint8 TargetFR)
 149          {
 150   1              static uint8 MC_FR = 0;
 151   1              static uint8 MC_HallStatus = 0;
 152   1      
 153   1              if (MC_HallStatus == 0) //ç¬¬ä¸€æ¬¡è¿›å…¥ä¸­æ–­
 154   1              {
 155   2                      MC_HallStatus = HallStatus;
 156   2                      MC_FR = CW;
 157   2                      return MC_FR;
 158   2              }
 159   1      
 160   1              if (MC_HallStatus != HallStatus)
 161   1              {
 162   2                      switch (MC_HallStatus)
 163   2                      {
 164   3                      case 1:
 165   3                              if (HallStatus == 5)
 166   3                              {
 167   4                                      if (TargetFR == CW)
 168   4                                      {
 169   5                                              MC_FR = CCW;
 170   5                                      }
 171   4                                      else
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 4   

 172   4                                      {
 173   5                                              MC_FR = CW;
 174   5                                      }
 175   4                              }
 176   3      
 177   3                              if (HallStatus == 3)
 178   3                              {
 179   4                                      if (TargetFR == CW)
 180   4                                      {
 181   5                                              MC_FR = CW;
 182   5                                      }
 183   4                                      else
 184   4                                      {
 185   5                                              MC_FR = CCW;
 186   5                                      }
 187   4                              }
 188   3      
 189   3                              break;
 190   3      
 191   3                      case 2:
 192   3                              if (HallStatus == 3)
 193   3                              {
 194   4                                      if (TargetFR == CW)
 195   4                                      {
 196   5                                              MC_FR = CCW;
 197   5                                      }
 198   4                                      else
 199   4                                      {
 200   5                                              MC_FR = CW;
 201   5                                      }
 202   4                              }
 203   3      
 204   3                              if (HallStatus == 6)
 205   3                              {
 206   4                                      if (TargetFR == CW)
 207   4                                      {
 208   5                                              MC_FR = CW;
 209   5                                      }
 210   4                                      else
 211   4                                      {
 212   5                                              MC_FR = CCW;
 213   5                                      }
 214   4                              }
 215   3      
 216   3                              break;
 217   3      
 218   3                      case 3:
 219   3                              if (HallStatus == 1)
 220   3                              {
 221   4                                      if (TargetFR == CW)
 222   4                                      {
 223   5                                              MC_FR = CCW;
 224   5                                      }
 225   4                                      else
 226   4                                      {
 227   5                                              MC_FR = CW;
 228   5                                      }
 229   4                              }
 230   3      
 231   3                              if (HallStatus == 2)
 232   3                              {
 233   4                                      if (TargetFR == CW)
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 5   

 234   4                                      {
 235   5                                              MC_FR = CW;
 236   5                                      }
 237   4                                      else
 238   4                                      {
 239   5                                              MC_FR = CCW;
 240   5                                      }
 241   4                              }
 242   3      
 243   3                              break;
 244   3      
 245   3                      case 4:
 246   3                              if (HallStatus == 6)
 247   3                              {
 248   4                                      if (TargetFR == CW)
 249   4                                      {
 250   5                                              MC_FR = CCW;
 251   5                                      }
 252   4                                      else
 253   4                                      {
 254   5                                              MC_FR = CW;
 255   5                                      }
 256   4                              }
 257   3      
 258   3                              if (HallStatus == 5)
 259   3                              {
 260   4                                      if (TargetFR == CW)
 261   4                                      {
 262   5                                              MC_FR = CW;
 263   5                                      }
 264   4                                      else
 265   4                                      {
 266   5                                              MC_FR = CCW;
 267   5                                      }
 268   4                              }
 269   3      
 270   3                              break;
 271   3      
 272   3                      case 5:
 273   3                              if (HallStatus == 4)
 274   3                              {
 275   4                                      if (TargetFR == CW)
 276   4                                      {
 277   5                                              MC_FR = CCW;
 278   5                                      }
 279   4                                      else
 280   4                                      {
 281   5                                              MC_FR = CW;
 282   5                                      }
 283   4                              }
 284   3      
 285   3                              if (HallStatus == 1)
 286   3                              {
 287   4                                      if (TargetFR == CW)
 288   4                                      {
 289   5                                              MC_FR = CW;
 290   5                                      }
 291   4                                      else
 292   4                                      {
 293   5                                              MC_FR = CCW;
 294   5                                      }
 295   4                              }
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 6   

 296   3      
 297   3                              break;
 298   3      
 299   3                      case 6:
 300   3                              if (HallStatus == 2)
 301   3                              {
 302   4                                      if (TargetFR == CW)
 303   4                                      {
 304   5                                              MC_FR = CCW;
 305   5                                      }
 306   4                                      else
 307   4                                      {
 308   5                                              MC_FR = CW;
 309   5                                      }
 310   4                              }
 311   3      
 312   3                              if (HallStatus == 4)
 313   3                              {
 314   4                                      if (TargetFR == CW)
 315   4                                      {
 316   5                                              MC_FR = CW;
 317   5                                      }
 318   4                                      else
 319   4                                      {
 320   5                                              MC_FR = CCW;
 321   5                                      }
 322   4                              }
 323   3      
 324   3                              break;
 325   3                      }
 326   2      
 327   2                      MC_HallStatus = HallStatus;
 328   2              }
 329   1      
 330   1              return MC_FR;
 331   1      }
 332          
 333          /* -------------------------------------------------------------------------------------------------
 334              Function Name  : BEMFSpeedDetect
 335              Description    : æ£€æµ‹é€Ÿåº¦çš„è®¡æ—¶
 336              Date           : 2021-12-30
 337              Parameter      : None
 338          ------------------------------------------------------------------------------------------------- */
 339          void BEMFSpeedDetect(void)
 340          {
 341   1          if(BEMFDetect.BEMFSpeedInitStatus == 0)
 342   1          {
 343   2              BEMFDetect.BEMFSpeedInitStatus =1;
 344   2      
 345   2              BEMFDetect.PeriodTime = 0;
 346   2              BEMFDetect.MC_StepTime[0] = 0;
 347   2              BEMFDetect.MC_StepTime[1] = 0;
 348   2              BEMFDetect.MC_StepTime[2] = 0;
 349   2              BEMFDetect.MC_StepTime[3] = 0;
 350   2              BEMFDetect.MC_StepTime[4] = 0;
 351   2              BEMFDetect.MC_StepTime[5] = 0;
 352   2              BEMFDetect.BEMFStep = 0;
 353   2              BEMFDetect.StepTime = 0;
 354   2              BEMFDetect.FirstCycle = 0;
 355   2          }
 356   1          else
 357   1          {
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 7   

 358   2              BEMFDetect.StepTime = TIM2__CNTR;
 359   2              TIM2__CNTR = 0;
 360   2      
 361   2              BEMFDetect.MC_StepTime[BEMFDetect.BEMFStep] = BEMFDetect.StepTime;
 362   2      
 363   2              BEMFDetect.PeriodTime = (BEMFDetect.MC_StepTime[0] + BEMFDetect.MC_StepTime[1] + BEMFDetect.MC_Ste
             -pTime[2]
 364   2                                      +BEMFDetect.MC_StepTime[3] + BEMFDetect.MC_StepTime[4] + BEMFDetect.MC_Ste
             -pTime[5]) >> 3;
 365   2      
 366   2              BEMFDetect.BEMFStep++;
 367   2      
 368   2              if(BEMFDetect.FirstCycle)                           //360åº¦ï¼Œç¬¬ä¸€åœˆæ˜¯360è®¡ç®—ä¸€æ¬¡é€Ÿåº¦ï¼
             -Œç¬¬äºŒåœˆæ˜¯60åº¦è®¡ç®—ä¸€æ¬¡é€Ÿåº¦
 369   2              {
 370   3                  BEMFDetect.FlagSpeedCal  = 1;
 371   3                  BEMFDetect.BEMFSpeedBase = TempBEMFSpeedBase;
 372   3              }
 373   2              else//60åº¦
 374   2              {
 375   3                  BEMFDetect.FlagSpeedCal  = 1;
 376   3                  BEMFDetect.BEMFSpeedBase = TempBEMFSpeedBase1;
 377   3                  BEMFDetect.PeriodTime    = BEMFDetect.StepTime;
 378   3              }
 379   2      
 380   2              if(BEMFDetect.BEMFStep == 6)
 381   2              {
 382   3                  BEMFDetect.FirstCycle = 1;
 383   3                  BEMFDetect.BEMFStep   = 0;
 384   3              }
 385   2          }
 386   1      }
 387          /* -------------------------------------------------------------------------------------------------
 388              Function Name  : BEMFSpeedCal
 389              Description    : é€Ÿåº¦è®¡ç®—ï¼Œå¾—åˆ°çš„æ˜¯Qæ ¼å¼çš„æ•°æ®
 390              Date           : 2021-12-30
 391              Parameter      : None
 392          ------------------------------------------------------------------------------------------------- */
 393          void BEMFSpeedCal(void)
 394          {
 395   1              if(BEMFDetect.FlagSpeedCal)                      //æ­¤å¤„æ³¨æ„XDATAå’Œé™¤æ•°åªèƒ½æ˜¯16ä½çš„é—®é¢˜
 396   1              {
 397   2                      DivQ_L_MDU(BEMFDetect.BEMFSpeedBase >> 16, BEMFDetect.BEMFSpeedBase, BEMFDetect.PeriodTime, BEMFDetect.B
             -EMFSpeed);
 398   2                      BEMFDetect.FlagSpeedCal = 0;
 399   2              }
 400   1      }
 401          
 402          /* -------------------------------------------------------------------------------------------------
 403              Function Name  : BEMFDetectFunc
 404              Description    : BEMFæ£€æµ‹ï¼Œåˆ¤æ–­æ–¹å‘ï¼Œé€Ÿåº¦ï¼Œä»¥åŠé¡ºé£Žåˆ‡é—­çŽ¯
 405              Date           : 2021-12-30
 406              Parameter      : None
 407          ------------------------------------------------------------------------------------------------- */
 408          void BEMFDetectFunc(void)
 409          {
 410   1          if(ReadBit(CMP_SR , CMP0IF)||ReadBit(CMP_SR , CMP1IF)||ReadBit(CMP_SR , CMP2IF))     //å½“æ£€æµ‹åˆ°æ¯”
             -è¾ƒå™¨ä¸­æ–­æ—¶
 411   1          {
 412   2      
 413   2              BEMFDetect.FRStatus = CWCCWDetect(CMP_SR & 0x07, mcFRState.TargetFR);
 414   2      
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 8   

 415   2              /* -----é€Ÿåº¦æ£€æµ‹----- */
 416   2              BEMFSpeedDetect();
 417   2                     
 418   2              /* -----é€Ÿåº¦è®¡ç®—----- */
 419   2              BEMFSpeedCal();
 420   2      
 421   2              if(BEMFDetect.BEMFStartStatus)                                                    //å¼ºåˆ¶å¯åŠ¨æ 
             -‡å¿—
 422   2              {
 423   3                                                                                                //CWæ—¶Uç›¸BEMFä
             -¸Šå‡æ²¿å¯åŠ¨ï¼ŒCCWæ—¶Vç›¸BEMFä¸Šå‡æ²¿å¯åŠ¨
 424   3                      if (((mcFRState.TargetFR == CW) && ((CMP_SR & 0x07) == 5)) || ((mcFRState.TargetFR == CCW) && ((C
             -MP_SR & 0x07) == 3)))
 425   3                  {                
 426   4                      /* -----é—­çŽ¯å¯åŠ¨----- */
 427   4                      BEMFFOCCloseLoopStart();
 428   4                      ClrBit(CMP_CR0 , CMP2IM1 | CMP2IM0 | CMP1IM1 | CMP1IM0 | CMP0IM1 | CMP0IM0);
 429   4                      ClrBit(CMP_CR2 , CMP0EN);
 430   4      
 431   4                      BEMFDetect.BEMFStartStatus = 0;
 432   4                  }
 433   3              }
 434   2              ClrBit(CMP_SR , CMP0IF | CMP1IF | CMP2IF);
 435   2          }
 436   1      }
 437          
 438          /* -------------------------------------------------------------------------------------------------
 439              Function Name  : BEMFDealwith
 440              Description    : BEMFå¤„ç†æ–¹å¼
 441              Date           : 2022-01-04
 442              Parameter      : None
 443          ------------------------------------------------------------------------------------------------- */
 444          void BEMFDealwith(void)
 445          {
 446   1          if((BEMFDetect.BEMFTimeCount > 0) && (BEMFDetect.BEMFTimeCount < (BEMF_START_DETECT_TIME - BEMF_START_
             -DELAY_TIME)))
 447   1          {
 448   2              if(BEMFDetect.FRStatus == CW)
 449   2              {
 450   3                if((BEMFDetect.BEMFSpeed > BEMFMotorStartSpeed) && (BEMFDetect.BEMFSpeed < BEMFMotorStartSpeedHi
             -gh))  //è¶…è¿‡è®¾å®šè½¬é€Ÿæ—¶ç›´æŽ¥å¯åŠ¨
 451   3                {
 452   4                  BEMFDetect.BEMFStartStatus = 1;
 453   4                }
 454   3              }       
 455   2              else if(BEMFDetect.FRStatus == CCW)             //åè½¬ï¼Œåˆ¹è½¦
 456   2              {
 457   3                  McStaSet.SetFlag.TailWindSetFlag = 0;
 458   3                  mcFocCtrl.State_Count = 100;                        
 459   3                  MOE = 0;                    
 460   3                  FOC_CR1 = 0x00;
 461   3                  ClrBit(DRV_CR, FOCEN);
 462   3                  DRV_DR  = DRV_ARR + 1;
 463   3                  DRV_CMR &= 0xFFC0;
 464   3                  DRV_CMR |= 0x015;                           // ä¸‰ç›¸ä¸‹æ¡¥è‡‚é€šï¼Œåˆ¹è½¦
 465   3                  ClrBit(DRV_CR, OCS);                        // OCS = 0, DRV_COMR;OCS = 1, FOC/SVPWM/SPWM
 466   3                  MOE = 1;
 467   3                  mcFocCtrl.TailWindStatus = Headwind;
 468   3              }
 469   2          }
 470   1              
 471   1          if((BEMFDetect.BEMFTimeCount == 0) && (BEMFDetect.BEMFSpeed < BEMFMotorStartSpeed))//é™æ­¢æˆ–ä½Žé€Ÿ
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 9   

 472   1          {
 473   2                ClrBit(CMP_CR0 , CMP2IM1 | CMP2IM0 | CMP1IM1 | CMP1IM0 | CMP0IM1 | CMP0IM0);
 474   2                ClrBit(CMP_CR2 , CMP0EN);
 475   2                mcFocCtrl.TailWindStatus = Staticwind;
 476   2          }
 477   1      }
 478          
 479          /* -------------------------------------------------------------------------------------------------
 480              Function Name  : BEMFFOCCloseLoopStart
 481              Description    : é¡ºé£Žå¯åŠ¨
 482              Date           : 2021-12-27
 483              Parameter      : None
 484          ------------------------------------------------------------------------------------------------- */
 485          void BEMFFOCCloseLoopStart(void)
 486          {       
 487   1              MOE = 0;
 488   1          FOC_Init();
 489   1          ClrBit(FOC_CR2,UQD); 
 490   1          ClrBit(FOC_CR2,UDD); 
 491   1          FOC_EFREQACC  = Motor_Omega_Ramp_ACC;
 492   1          FOC_EFREQMIN  = Motor_Omega_Ramp_Min;
 493   1          FOC_EFREQHOLD = Motor_Omega_Ramp_End;    
 494   1          ClrBit(FOC_CR2,UDD);
 495   1          ClrBit(FOC_CR2, ESEL);                              //åˆ‡æ¢åˆ°SMOæ¨¡å¼    
 496   1          SetBit(FOC_CR0, ESCMS);
 497   1          FOC_EKLPFMIN  = OBS_EA_KS;
 498   1          FOC_KSLIDE = OBS_KSLIDE;
 499   1              
 500   1          /*å¯åŠ¨ç”µæµã€KPã€KI*/
 501   1          FOC_IDREF = ID_Start_CURRENT;                       // Dè½´å¯åŠ¨ç”µæµ 
 502   1          
 503   1          FOC__THECOMP = _Q15(2.0 / 180.0);                   // SMO ä¼°ç®—è¡¥å¿è§’
 504   1          FOC__THECOR  = 0x00;                                // è¯¯å·®è§’åº¦è¡¥å¿
 505   1      
 506   1          FOC_DQKP = DQKP_TailWind;
 507   1          FOC_DQKI = DQKI_TailWind; 
 508   1                
 509   1          SetBit(FOC_CR1, EFAE);                              // ä¼°ç®—å™¨å¼ºåˆ¶è¾“å‡º
 510   1          ClrBit(FOC_CR1, RFAE);                              // ç¦æ­¢å¼ºæ‹‰
 511   1          SetBit(FOC_CR1, ANGM);                              // ä¼°ç®—æ¨¡å¼
 512   1          
 513   1          FOC_EKP = OBSW_KP_GAIN_RUN4;                        // ä¼°ç®—å™¨é‡Œçš„PIçš„KP
 514   1          FOC_EKI = OBSW_KI_GAIN_RUN4;                        // ä¼°ç®—å™¨é‡Œçš„PIçš„KI
 515   1          
 516   1          mcFocCtrl.State_Count=200;
 517   1          
 518   1          FOC_OMEKLPF  = SPEED_KLPF;
 519   1          
 520   1          mcFocCtrl.mcIqref = IQ_TailWind_CURRENT;
 521   1          
 522   1          FOC_IQREF =mcFocCtrl.mcIqref; 
 523   1          
 524   1          mcFocCtrl.TailWindStatus = Downwind;
 525   1              
 526   1          McStaSet.SetFlag.StartSetFlag = 0;
 527   1          #if (Open_Start_Mode == PLL_Start)
                  {            
                      PLLfunction.PLLFunctionFlag = 3;            
                  }
                  #endif
 532   1          DRV_CMR  = 0x00;
 533   1          DRV_CMR |= 0x3F;
C51 COMPILER V9.00   BEMFDETECT                                                            01/15/2025 09:25:08 PAGE 10  

 534   1              MOE = 1;
 535   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1359    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     43    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
