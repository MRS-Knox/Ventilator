C51 COMPILER V9.00   MAIN                                                                  01/15/2025 09:25:07 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Debug\main.obj
COMPILER INVOKED BY: E:\KEIL\KEIL4\C51\BIN\C51.EXE ..\User\source\Application\main.c LARGE OMF2 BROWSE INCDIR(..\FU68xx_
                    -Hardware_Driver\Include;..\User\include) DEBUG PRINT(.\Listings\main.lst) OBJECT(.\Debug\main.obj)

line level    source

   1          /**
   2           * @copyright (C) COPYRIGHT 2022 Fortiortech Shenzhen
   3           * @file      main.c
   4           * @author    Fortiortech  Appliction Team
   5           * @since     Create:2021-05-14
   6           * @date      Last modify:2022-07-14
   7           * @brief     包含主函数，软硬件初始化函数，VRER配置函数
   8           */
   9          
  10          
  11          #include <FU68xx_4.h>
  12          #include <Myproject.h>
  13          #include "UART.h"
  14          /*  ------------------------------------------------------------------------------------
  15              Internal Routine Prototypes
  16              ------------------------------------------------------------------------------------ */
  17          void HardwareInit(void);
  18          void SoftwareInit(void);
  19          void VREFConfigInit(void);
  20          
  21          /**
  22           * @brief        主函数主要功能是初始化，
  23                               1、包括上电等待，软件初始化，硬件初始化，调试模式设置，主
             -循环扫描。
  24                               2、软件初始化--初始化所有定义的变量
  25                               3、硬件初始化--初始化硬件设备配置
  26                               4、大循环运行偏置电流采集函数，电机状态机控制函数，以及环
             -路响应函数
  27           */
  28          void main(void)
  29          {
  30   1          uint32 PowerUpCnt = 0;
  31   1          
  32   1          for (PowerUpCnt = 0; PowerUpCnt < SystemPowerUpTime; PowerUpCnt++) {};
  33   1          
  34   1          /* -----ADC参考电压配置----- */
  35   1          VREFConfigInit();
  36   1          
  37   1          /* -----硬件初始化----- */
  38   1          HardwareInit();
  39   1          
  40   1          /* -----软件初始化----- */
  41   1          SoftwareInit();
  42   1      
  43   1              FG.TIMcalc_temp = 60 / Pole_Pairs * TIM4_Fre / FG_K;          //用来定时器输出FG信号
  44   1              EA = 1;
  45   1      
  46   1          /* -----等待主芯片发送通电数据----- */
  47   1              while(1){
  48   2                      if(Motor_Return() == 1)
  49   2                              break;
  50   2                      for(PowerUpCnt = 0;PowerUpCnt <= 2000;PowerUpCnt++)
  51   2                              _nop_();
  52   2              }
C51 COMPILER V9.00   MAIN                                                                  01/15/2025 09:25:07 PAGE 2   

  53   1          
  54   1          /* -----看门狗初始化----- */
  55   1          WatchDogConfig(200);
  56   1              
  57   1              PowerUpCnt = 0;
  58   1              
  59   1          while (1)
  60   1          {
  61   2                      /* -----机器开机运行----- */
  62   2                      if(blower_state_t.set_speed > 0 || (blower_state_t.set_speed == 0 && blower_state_t.actual_speed > 0)){
  63   3                              /* -----硬件电路校准---- */
  64   3                              GetCurrentOffset();
  65   3                              /* -----电机状态机----- */
  66   3                              MC_Control();
  67   3                      }
  68   2                      /* -----1ms中断服务函数----- */
  69   2                      if (g_1mTick)
  70   2                      {
  71   3                              Function_1_MS_((uint32)blower_state_t.set_speed);
  72   3                              SetBit(WDT_CR, WDTRF);                    //看门狗清零
  73   3                              EA = 0;
  74   3                              g_1mTick = 0;
  75   3                              EA = 1;
  76   3                              blower_state_t.actual_speed = (mcFocCtrl.SpeedFlt*MOTOR_SPEED_BASE)/32767;      
  77   3                              PowerUpCnt++;
  78   3                      }
  79   2                      /* -----200ms返回一次数据----- */
  80   2                      if(PowerUpCnt >= 200)   
  81   2                      {
  82   3                              PowerUpCnt = 0;
  83   3                              Motor_Return();
  84   3                      }
  85   2          }
  86   1      }
  87          
  88          /* -------------------------------------------------------------------------------------------------
  89              Function Name  : HardwareInit
  90              Description    : 硬件初始化，初始化需要使用的硬件设备配置，FOC必须配置的是
             -放电压、运放初始化、ADC初始化、Driver初始化
  91              Date           : 2021-12-04
  92              Parameter      : None
  93          ------------------------------------------------------------------------------------------------- */
  94          void HardwareInit(void)
  95          {
  96   1          GPIO_DefaultInit();   //配置上拉
  97   1          #if (HardwareCurrent_Protect == Hardware_CMP_Protect)
  98   1          {
  99   2              /* -----硬件过流，比较器初始化用于硬件过流保护----- */
 100   2              CMP3_Init();
 101   2          }
 102   1          #else
                  {
                      _nop_();
                  }
                  #endif
 107   1          /* -----GPIO初始化----- */
 108   1          GPIO_Init();
 109   1          /* -----ADC初始化----- */
 110   1          ADC_Init();
 111   1          /* -----驱动初始化配置----- */
 112   1          Driver_Init();
 113   1          /* -----运放初始化----- */
C51 COMPILER V9.00   MAIN                                                                  01/15/2025 09:25:07 PAGE 3   

 114   1          AMP_Init();
 115   1          /* -----中断配置----- */
 116   1          CMP3_Interrupt_Init();
 117   1          /* -----UART2配置----- */
 118   1              UART2_Init();
 119   1          #if (FGEnable)
 120   1          {
 121   2              /* -----FG对应Timer初始化配置----- */
 122   2              Timer4_Init();
 123   2          }
 124   1          #endif
 125   1          #if (SPEED_MODE == PWMMODE)
                  {
                      /* -----PWM捕获对应Timer初始化配置----- */
                      Timer3_Init();
                  }
                  #endif
 131   1          PTIM4S1 = 1;
 132   1          PTIM4S0 = 0;                                    //Systick(1ms定时中断)优先级别为1
 133   1          SetBit(DRV_SR, SYSTIE);
 134   1      }
 135          
 136          /* -------------------------------------------------------------------------------------------------
 137              Function Name  : SoftwareInit
 138              Description    : 软件初始化
 139              Date           : 2021-12-04
 140              Parameter      : None
 141          ------------------------------------------------------------------------------------------------- */
 142          void SoftwareInit(void)
 143          {
 144   1          /* -----变量初始化----- */
 145   1          MotorcontrolInit();
 146   1          mcState = mcReady;
 147   1          mcFaultSource = FaultNoSource;
 148   1      }
 149          
 150          /* -------------------------------------------------------------------------------------------------
 151              Function Name  : VREFConfigInit
 152              Description    : 配置VREF/VHALF输出
 153              Date           : 2021-12-03
 154              Parameter      : None
 155          ------------------------------------------------------------------------------------------------- */
 156          void VREFConfigInit(void)
 157          {
 158   1          ClrBit(VREF_VHALF_CR, VRVSEL1);             //00-->4.5V   01-->VDD5
 159   1          SetBit(VREF_VHALF_CR, VRVSEL0);             //10-->3.0V   11-->4.0V
 160   1          SetBit(VREF_VHALF_CR, VREFEN | VHALFEN);
 161   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    462    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
C51 COMPILER V9.00   MAIN                                                                  01/15/2025 09:25:07 PAGE 4   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
